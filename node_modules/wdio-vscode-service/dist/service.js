import fs from 'node:fs/promises';
import url from 'node:url';
import util from 'node:util';
import path from 'node:path';
import slash from 'slash';
import tmp from 'tmp-promise';
import logger from '@wdio/logger';
import getPort from 'get-port';
import decamelize from 'decamelize';
import { WebSocketServer } from 'ws';
import { SevereServiceError } from 'webdriverio';
import { Workbench } from './pageobjects/index.js';
import { getLocators, getValueSuffix, isVSCodeCapability } from './utils.js';
import { VSCODE_APPLICATION_ARGS, DEFAULT_VSCODE_SETTINGS, DEFAULT_PROXY_OPTIONS, SETTINGS_KEY, VSCODE_CAPABILITY_KEY, DEFAULT_VSCODE_WEB_PORT } from './constants.js';
const log = logger('wdio-vscode-service');
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
export default class VSCodeWorkerService {
    constructor(_, _capabilities) {
        this._capabilities = _capabilities;
        this._messageId = 0;
        this._pendingMessages = new Map();
        this._isWebSession = false;
        this._isCucumberSession = false;
        this._deletingSession = false;
        this._vscodeOptions = this._capabilities[VSCODE_CAPABILITY_KEY] || {};
        this._proxyOptions = { ...DEFAULT_PROXY_OPTIONS, ...this._vscodeOptions.vscodeProxyOptions };
    }
    _handleIncoming(data) {
        try {
            const message = JSON.parse(data.toString('utf-8'));
            const resolver = this._pendingMessages.get(message.id);
            if (!resolver) {
                log.error(`Couldn't find remote message resolver with id ${message.id}`);
                return;
            }
            resolver(message.error, message.result);
        }
        catch (err) {
            log.error(`Error parsing remote response: ${err.message}`);
        }
    }
    _handleSocketClose(code, reason) {
        /*
         * Prevent this block from running when deleting a session using the Cucumber framework.
         * Otherwise the specs fail with the "Connection closed" error.
         */
        if (this._isCucumberSession && this._deletingSession) {
            return;
        }
        const msg = `Connection closed. Code: ${code}, reason: ${reason.toString()}`;
        this._promisedSocket = Promise.reject(new Error(msg));
        this._pendingMessages.forEach((resolver) => resolver(msg, null));
    }
    async beforeSession(option, capabilities) {
        this._isWebSession = capabilities.browserName !== 'vscode';
        this._isCucumberSession = option.framework === 'cucumber';
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * if we run tests for a web extension
         */
        if (this._isWebSession) {
            const serverOptions = capabilities[VSCODE_CAPABILITY_KEY]?.serverOptions;
            option.baseUrl = util.format('http://%s:%s', serverOptions?.hostname || 'localhost', (serverOptions?.port || DEFAULT_VSCODE_WEB_PORT).toString());
            log.info(`Run VSCode as web app on ${option.baseUrl}`);
            return;
        }
        const customArgs = { ...VSCODE_APPLICATION_ARGS };
        const storagePath = this._vscodeOptions.storagePath ?? (await tmp.dir()).path;
        const userSettingsPath = path.join(storagePath, 'settings', 'User');
        const userSettings = {
            ...DEFAULT_VSCODE_SETTINGS,
            ...(this._vscodeOptions.userSettings || {})
        };
        if (!this._vscodeOptions.extensionPath) {
            throw new SevereServiceError('No extension path provided');
        }
        if (this._proxyOptions.enable) {
            const port = await getPort({ port: this._proxyOptions.port });
            userSettings[SETTINGS_KEY].port = port;
            log.info(`Start VSCode proxy server on port ${port}`);
            const wss = this._wss = new WebSocketServer({ port });
            this._deletingSession = false;
            this._promisedSocket = new Promise((resolve, reject) => {
                const socketTimeout = setTimeout(() => reject(new Error('Connection timeout exceeded')), this._proxyOptions.connectionTimeout);
                wss.on('connection', (socket) => {
                    log.info('Connected with VSCode workbench');
                    this._promisedSocket = Promise.resolve(socket);
                    resolve(socket);
                    clearTimeout(socketTimeout);
                    socket.on('message', this._handleIncoming.bind(this));
                    socket.once('close', this._handleSocketClose.bind(this));
                });
            });
        }
        customArgs.extensionDevelopmentPath = slash(this._vscodeOptions.extensionPath);
        customArgs.extensionTestsPath = slash(path.join(__dirname, 'proxy', 'cjs', 'entry.js'));
        customArgs.userDataDir = slash(path.join(storagePath, 'settings'));
        customArgs.extensionsDir = slash(path.join(storagePath, 'extensions'));
        customArgs.vscodeBinaryPath = this._vscodeOptions.binary;
        log.info(`Setting up VSCode directory at ${userSettingsPath}`);
        await fs.mkdir(userSettingsPath, { recursive: true });
        await fs.writeFile(path.join(userSettingsPath, 'settings.json'), JSON.stringify(userSettings), 'utf-8');
        if (this._vscodeOptions.workspacePath) {
            customArgs.folderUri = `file:${slash(this._vscodeOptions.workspacePath)}`;
        }
        if (this._vscodeOptions.filePath) {
            customArgs.fileUri = `file:${slash(this._vscodeOptions.filePath)}`;
        }
        if (this._vscodeOptions.verboseLogging) {
            customArgs.verbose = true;
            customArgs.logExtensionHostCommunication = true;
        }
        const binary = path.join(__dirname, 'chromium', `index.${process.platform === 'win32' ? 'exe' : 'js'}`);
        const args = Object.entries({ ...customArgs, ...this._vscodeOptions.vscodeArgs }).reduce((prev, [key, value]) => {
            const decamelizedKey = decamelize(key, { separator: '-' });
            if (Array.isArray(value)) {
                const expandedArgs = value.map((val) => `--${decamelizedKey}${getValueSuffix(val)}`);
                return [...prev, ...expandedArgs];
            }
            return [...prev, `--${decamelizedKey}${getValueSuffix(value)}`];
        }, []);
        /**
         * need to rename capability back to Chrome otherwise Chromedriver
         * won't recognise this capability
         */
        capabilities.browserName = 'chrome';
        capabilities['goog:chromeOptions'] = { binary, args, windowTypes: ['webview'] };
        log.info(`Start VSCode: ${binary} ${args.join(' ')}`);
    }
    beforeCommand(commandName) {
        if (commandName === 'deleteSession') {
            this._deletingSession = true;
        }
    }
    async before(capabilities, __, browser) {
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * open VSCode web when testing web extensions
         */
        if (this._isWebSession) {
            await browser.url('/');
        }
        const vsCodeVersion = capabilities[VSCODE_CAPABILITY_KEY]?.version || capabilities.browserVersion || 'insiders';
        this._browser = browser;
        const locators = await getLocators(vsCodeVersion);
        const workbenchPO = new Workbench(locators);
        this._browser.addCommand('getWorkbench', () => workbenchPO.wait());
        this._browser.addCommand('executeWorkbench', this._executeVSCode.bind(this));
        this._browser.addCommand('getVSCodeVersion', () => vsCodeVersion);
        this._browser.addCommand('isVSCodeWebSession', () => this._isWebSession);
        this._browser.addCommand('getVSCodeChannel', () => (capabilities.browserVersion === 'insiders' ? 'insiders' : 'vscode'));
        await workbenchPO.elem.waitForExist();
        /**
         * VSCode in the browser doesn't allow to have a file directly opened,
         * therefore we need to open it automatically
         */
        if (this._isWebSession && this._vscodeOptions.filePath && this._vscodeOptions.workspacePath) {
            const sections = this._vscodeOptions.filePath.replace(this._vscodeOptions.workspacePath, '')
                .split(path.sep).filter(Boolean);
            const fileExplorer = await browser.$('.explorer-folders-view');
            while (sections.length > 0) {
                const entry = sections.shift();
                await fileExplorer.$(`span=${entry}`).click();
            }
        }
    }
    async after() {
        if (!isVSCodeCapability(this._capabilities)
            || !this._browser
            || !this._capabilities[VSCODE_CAPABILITY_KEY]?.verboseLogging) {
            return;
        }
        const logs = await this._browser.getLogs('browser').then((res) => res, (err) => err);
        if (logs instanceof Error) {
            return;
        }
        for (const l of logs) {
            log.info(`[${(new Date(l.timestamp)).toISOString()}]`
                + ` - ${l.source} - ${l.message}`);
        }
        if (this._wss) {
            this._wss.close();
        }
    }
    async _executeVSCode(fn, ...params) {
        if (!this._promisedSocket || this._isWebSession) {
            const errorMessage = this._isWebSession
                ? 'not support when testing web extensions'
                : 'see "vscodeProxyOptions" option in service docs';
            throw new Error(`VSCode API proxy not enabled, ${errorMessage}`);
        }
        const socket = await this._promisedSocket;
        const proxyFn = typeof fn === 'function'
            ? fn.toString()
            : fn;
        socket.send(JSON.stringify({
            id: this._messageId,
            fn: proxyFn,
            params
        }));
        const returnVal = new Promise((resolve, reject) => {
            const cmdTimeout = setTimeout(() => reject(new Error('Remote command timeout exceeded')), this._proxyOptions.commandTimeout);
            this._pendingMessages.set(this._messageId, (error, result) => {
                clearTimeout(cmdTimeout);
                if (error) {
                    reject(new Error(error));
                    return;
                }
                resolve(result);
            });
        });
        this._messageId += 1;
        return returnVal;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQTtBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFDNUIsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFBO0FBQzVCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUE7QUFDN0IsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQTtBQUM5QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUE7QUFDbkMsT0FBTyxFQUFFLGVBQWUsRUFBYSxNQUFNLElBQUksQ0FBQTtBQUUvQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFFaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzVFLE9BQU8sRUFDSCx1QkFBdUIsRUFBRSx1QkFBdUIsRUFBRSxxQkFBcUIsRUFDdkUsWUFBWSxFQUFFLHFCQUFxQixFQUFFLHVCQUF1QixFQUMvRCxNQUFNLGdCQUFnQixDQUFBO0FBTXZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNsRSxNQUFNLENBQUMsT0FBTyxPQUFPLG1CQUFtQjtJQVlwQyxZQUFhLENBQVEsRUFBVSxhQUFpQztRQUFqQyxr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QUFTLENBQWdCO1lBQ3RDLEVBQUUsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUNuQixFQUFFLEVBQUUsT0FBTztZQUNYLE1BQU07U0FDVCxDQUFDLENBQUMsQ0FBQTtRQUVILE1BQU0sU0FBUyxHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzlDLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FDekIsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUMsRUFDMUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQ3BDLENBQUE7WUFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxLQUF5QixFQUFFLE1BQVcsRUFBRSxFQUFFO2dCQUNsRixZQUFZLENBQUMsVUFBVSxDQUFDLENBQUE7Z0JBQ3hCLElBQUksS0FBSyxFQUFFLENBQUM7b0JBQ1IsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7b0JBQ3hCLE9BQU07Z0JBQ1YsQ0FBQztnQkFDRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDbkIsQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFBO1FBQ3BCLE9BQU8sU0FBUyxDQUFBO0lBQ3BCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdub2RlOmZzL3Byb21pc2VzJ1xuaW1wb3J0IHVybCBmcm9tICdub2RlOnVybCdcbmltcG9ydCB1dGlsIGZyb20gJ25vZGU6dXRpbCdcbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCdcbmltcG9ydCBzbGFzaCBmcm9tICdzbGFzaCdcbmltcG9ydCB0bXAgZnJvbSAndG1wLXByb21pc2UnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCBnZXRQb3J0IGZyb20gJ2dldC1wb3J0J1xuaW1wb3J0IGRlY2FtZWxpemUgZnJvbSAnZGVjYW1lbGl6ZSdcbmltcG9ydCB7IFdlYlNvY2tldFNlcnZlciwgV2ViU29ja2V0IH0gZnJvbSAnd3MnXG5pbXBvcnQgeyBTZXJ2aWNlcywgT3B0aW9ucyB9IGZyb20gJ0B3ZGlvL3R5cGVzJ1xuaW1wb3J0IHsgU2V2ZXJlU2VydmljZUVycm9yIH0gZnJvbSAnd2ViZHJpdmVyaW8nXG5cbmltcG9ydCB7IFdvcmtiZW5jaCB9IGZyb20gJy4vcGFnZW9iamVjdHMvaW5kZXguanMnXG5pbXBvcnQgeyBnZXRMb2NhdG9ycywgZ2V0VmFsdWVTdWZmaXgsIGlzVlNDb2RlQ2FwYWJpbGl0eSB9IGZyb20gJy4vdXRpbHMuanMnXG5pbXBvcnQge1xuICAgIFZTQ09ERV9BUFBMSUNBVElPTl9BUkdTLCBERUZBVUxUX1ZTQ09ERV9TRVRUSU5HUywgREVGQVVMVF9QUk9YWV9PUFRJT05TLFxuICAgIFNFVFRJTkdTX0tFWSwgVlNDT0RFX0NBUEFCSUxJVFlfS0VZLCBERUZBVUxUX1ZTQ09ERV9XRUJfUE9SVFxufSBmcm9tICcuL2NvbnN0YW50cy5qcydcbmltcG9ydCB0eXBlIHtcbiAgICBWU0NvZGVDYXBhYmlsaXRpZXMsIFdESU9Mb2dzLCBBcmdzUGFyYW1zLCBSZW1vdGVDb21tYW5kLCBSZW1vdGVSZXNwb25zZSxcbiAgICBQZW5kaW5nTWVzc2FnZVJlc29sdmVyLCBWU0NvZGVQcm94eU9wdGlvbnMsIFZTQ29kZU9wdGlvbnNcbn0gZnJvbSAnLi90eXBlcy5qcydcblxuY29uc3QgbG9nID0gbG9nZ2VyKCd3ZGlvLXZzY29kZS1zZXJ2aWNlJylcbmNvbnN0IF9fZGlybmFtZSA9IHVybC5maWxlVVJMVG9QYXRoKG5ldyBVUkwoJy4nLCBpbXBvcnQubWV0YS51cmwpKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVlNDb2RlV29ya2VyU2VydmljZSBpbXBsZW1lbnRzIFNlcnZpY2VzLlNlcnZpY2VJbnN0YW5jZSB7XG4gICAgcHJpdmF0ZSBfYnJvd3Nlcj86IFdlYmRyaXZlcklPLkJyb3dzZXJcbiAgICBwcml2YXRlIF93c3M/OiBXZWJTb2NrZXRTZXJ2ZXJcbiAgICBwcml2YXRlIF9tZXNzYWdlSWQgPSAwXG4gICAgcHJpdmF0ZSBfcGVuZGluZ01lc3NhZ2VzID0gbmV3IE1hcDxudW1iZXIsIFBlbmRpbmdNZXNzYWdlUmVzb2x2ZXI+KClcbiAgICBwcml2YXRlIF9wcm9taXNlZFNvY2tldD86IFByb21pc2U8V2ViU29ja2V0PlxuICAgIHByaXZhdGUgX3Byb3h5T3B0aW9uczogVlNDb2RlUHJveHlPcHRpb25zXG4gICAgcHJpdmF0ZSBfdnNjb2RlT3B0aW9uczogVlNDb2RlT3B0aW9uc1xuICAgIHByaXZhdGUgX2lzV2ViU2Vzc2lvbiA9IGZhbHNlXG4gICAgcHJpdmF0ZSBfaXNDdWN1bWJlclNlc3Npb24gPSBmYWxzZVxuICAgIHByaXZhdGUgX2RlbGV0aW5nU2Vzc2lvbiA9IGZhbHNlXG5cbiAgICBjb25zdHJ1Y3RvciAoXzogbmV2ZXIsIHByaXZhdGUgX2NhcGFiaWxpdGllczogVlNDb2RlQ2FwYWJpbGl0aWVzKSB7XG4gICAgICAgIHRoaXMuX3ZzY29kZU9wdGlvbnMgPSB0aGlzLl9jYXBhYmlsaXRpZXNbVlNDT0RFX0NBUEFCSUxJVFlfS0VZXSB8fCA8VlNDb2RlT3B0aW9ucz57fVxuICAgICAgICB0aGlzLl9wcm94eU9wdGlvbnMgPSB7IC4uLkRFRkFVTFRfUFJPWFlfT1BUSU9OUywgLi4udGhpcy5fdnNjb2RlT3B0aW9ucy52c2NvZGVQcm94eU9wdGlvbnMgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZUluY29taW5nIChkYXRhOiBCdWZmZXIpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGEudG9TdHJpbmcoJ3V0Zi04JykpIGFzIFJlbW90ZVJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCByZXNvbHZlciA9IHRoaXMuX3BlbmRpbmdNZXNzYWdlcy5nZXQobWVzc2FnZS5pZClcblxuICAgICAgICAgICAgaWYgKCFyZXNvbHZlcikge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihgQ291bGRuJ3QgZmluZCByZW1vdGUgbWVzc2FnZSByZXNvbHZlciB3aXRoIGlkICR7bWVzc2FnZS5pZH1gKVxuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNvbHZlcihtZXNzYWdlLmVycm9yLCBtZXNzYWdlLnJlc3VsdClcbiAgICAgICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcihgRXJyb3IgcGFyc2luZyByZW1vdGUgcmVzcG9uc2U6ICR7ZXJyLm1lc3NhZ2V9YClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZVNvY2tldENsb3NlIChjb2RlOiBudW1iZXIsIHJlYXNvbjogQnVmZmVyKSB7XG4gICAgICAgIC8qXG4gICAgICAgICAqIFByZXZlbnQgdGhpcyBibG9jayBmcm9tIHJ1bm5pbmcgd2hlbiBkZWxldGluZyBhIHNlc3Npb24gdXNpbmcgdGhlIEN1Y3VtYmVyIGZyYW1ld29yay5cbiAgICAgICAgICogT3RoZXJ3aXNlIHRoZSBzcGVjcyBmYWlsIHdpdGggdGhlIFwiQ29ubmVjdGlvbiBjbG9zZWRcIiBlcnJvci5cbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLl9pc0N1Y3VtYmVyU2Vzc2lvbiAmJiB0aGlzLl9kZWxldGluZ1Nlc3Npb24pIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbXNnID0gYENvbm5lY3Rpb24gY2xvc2VkLiBDb2RlOiAke2NvZGV9LCByZWFzb246ICR7cmVhc29uLnRvU3RyaW5nKCl9YFxuICAgICAgICB0aGlzLl9wcm9taXNlZFNvY2tldCA9IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihtc2cpKVxuICAgICAgICB0aGlzLl9wZW5kaW5nTWVzc2FnZXMuZm9yRWFjaCgocmVzb2x2ZXIpID0+IHJlc29sdmVyKG1zZywgbnVsbCkpXG4gICAgfVxuXG4gICAgYXN5bmMgYmVmb3JlU2Vzc2lvbiAob3B0aW9uOiBPcHRpb25zLlRlc3RydW5uZXIsIGNhcGFiaWxpdGllczogVlNDb2RlQ2FwYWJpbGl0aWVzKSB7XG4gICAgICAgIHRoaXMuX2lzV2ViU2Vzc2lvbiA9IGNhcGFiaWxpdGllcy5icm93c2VyTmFtZSAhPT0gJ3ZzY29kZSdcbiAgICAgICAgdGhpcy5faXNDdWN1bWJlclNlc3Npb24gPSBvcHRpb24uZnJhbWV3b3JrID09PSAnY3VjdW1iZXInXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9ubHkgcnVuIHNldHVwIGZvciBWU0NvZGUgY2FwYWJpbGl0aWVzXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIWlzVlNDb2RlQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBpZiB3ZSBydW4gdGVzdHMgZm9yIGEgd2ViIGV4dGVuc2lvblxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMuX2lzV2ViU2Vzc2lvbikge1xuICAgICAgICAgICAgY29uc3Qgc2VydmVyT3B0aW9ucyA9IGNhcGFiaWxpdGllc1tWU0NPREVfQ0FQQUJJTElUWV9LRVldPy5zZXJ2ZXJPcHRpb25zXG4gICAgICAgICAgICBvcHRpb24uYmFzZVVybCA9IHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICdodHRwOi8vJXM6JXMnLFxuICAgICAgICAgICAgICAgIHNlcnZlck9wdGlvbnM/Lmhvc3RuYW1lIHx8ICdsb2NhbGhvc3QnLFxuICAgICAgICAgICAgICAgIChzZXJ2ZXJPcHRpb25zPy5wb3J0IHx8IERFRkFVTFRfVlNDT0RFX1dFQl9QT1JUIGFzIG51bWJlcikudG9TdHJpbmcoKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgbG9nLmluZm8oYFJ1biBWU0NvZGUgYXMgd2ViIGFwcCBvbiAke29wdGlvbi5iYXNlVXJsfWApXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGN1c3RvbUFyZ3M6IEFyZ3NQYXJhbXMgPSB7IC4uLlZTQ09ERV9BUFBMSUNBVElPTl9BUkdTIH1cbiAgICAgICAgY29uc3Qgc3RvcmFnZVBhdGggPSB0aGlzLl92c2NvZGVPcHRpb25zLnN0b3JhZ2VQYXRoID8/IChhd2FpdCB0bXAuZGlyKCkpLnBhdGhcbiAgICAgICAgY29uc3QgdXNlclNldHRpbmdzUGF0aCA9IHBhdGguam9pbihzdG9yYWdlUGF0aCwgJ3NldHRpbmdzJywgJ1VzZXInKVxuICAgICAgICBjb25zdCB1c2VyU2V0dGluZ3M6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XG4gICAgICAgICAgICAuLi5ERUZBVUxUX1ZTQ09ERV9TRVRUSU5HUyxcbiAgICAgICAgICAgIC4uLih0aGlzLl92c2NvZGVPcHRpb25zLnVzZXJTZXR0aW5ncyB8fCB7fSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5fdnNjb2RlT3B0aW9ucy5leHRlbnNpb25QYXRoKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgU2V2ZXJlU2VydmljZUVycm9yKCdObyBleHRlbnNpb24gcGF0aCBwcm92aWRlZCcpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fcHJveHlPcHRpb25zLmVuYWJsZSkge1xuICAgICAgICAgICAgY29uc3QgcG9ydCA9IGF3YWl0IGdldFBvcnQoeyBwb3J0OiB0aGlzLl9wcm94eU9wdGlvbnMucG9ydCB9KVxuICAgICAgICAgICAgdXNlclNldHRpbmdzW1NFVFRJTkdTX0tFWV0ucG9ydCA9IHBvcnRcbiAgICAgICAgICAgIGxvZy5pbmZvKGBTdGFydCBWU0NvZGUgcHJveHkgc2VydmVyIG9uIHBvcnQgJHtwb3J0fWApXG4gICAgICAgICAgICBjb25zdCB3c3MgPSB0aGlzLl93c3MgPSBuZXcgV2ViU29ja2V0U2VydmVyKHsgcG9ydCB9KVxuICAgICAgICAgICAgdGhpcy5fZGVsZXRpbmdTZXNzaW9uID0gZmFsc2VcbiAgICAgICAgICAgIHRoaXMuX3Byb21pc2VkU29ja2V0ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNvY2tldFRpbWVvdXQgPSBzZXRUaW1lb3V0KFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiByZWplY3QobmV3IEVycm9yKCdDb25uZWN0aW9uIHRpbWVvdXQgZXhjZWVkZWQnKSksXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Byb3h5T3B0aW9ucy5jb25uZWN0aW9uVGltZW91dFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdDb25uZWN0ZWQgd2l0aCBWU0NvZGUgd29ya2JlbmNoJylcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvbWlzZWRTb2NrZXQgPSBQcm9taXNlLnJlc29sdmUoc29ja2V0KVxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNvY2tldClcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNvY2tldFRpbWVvdXQpXG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIHRoaXMuX2hhbmRsZUluY29taW5nLmJpbmQodGhpcykpXG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5vbmNlKCdjbG9zZScsIHRoaXMuX2hhbmRsZVNvY2tldENsb3NlLmJpbmQodGhpcykpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjdXN0b21BcmdzLmV4dGVuc2lvbkRldmVsb3BtZW50UGF0aCA9IHNsYXNoKHRoaXMuX3ZzY29kZU9wdGlvbnMuZXh0ZW5zaW9uUGF0aClcbiAgICAgICAgY3VzdG9tQXJncy5leHRlbnNpb25UZXN0c1BhdGggPSBzbGFzaChwYXRoLmpvaW4oX19kaXJuYW1lLCAncHJveHknLCAnY2pzJywgJ2VudHJ5LmpzJykpXG4gICAgICAgIGN1c3RvbUFyZ3MudXNlckRhdGFEaXIgPSBzbGFzaChwYXRoLmpvaW4oc3RvcmFnZVBhdGgsICdzZXR0aW5ncycpKVxuICAgICAgICBjdXN0b21BcmdzLmV4dGVuc2lvbnNEaXIgPSBzbGFzaChwYXRoLmpvaW4oc3RvcmFnZVBhdGgsICdleHRlbnNpb25zJykpXG4gICAgICAgIGN1c3RvbUFyZ3MudnNjb2RlQmluYXJ5UGF0aCA9IHRoaXMuX3ZzY29kZU9wdGlvbnMuYmluYXJ5IGFzIHN0cmluZ1xuXG4gICAgICAgIGxvZy5pbmZvKGBTZXR0aW5nIHVwIFZTQ29kZSBkaXJlY3RvcnkgYXQgJHt1c2VyU2V0dGluZ3NQYXRofWApXG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKHVzZXJTZXR0aW5nc1BhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pXG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShcbiAgICAgICAgICAgIHBhdGguam9pbih1c2VyU2V0dGluZ3NQYXRoLCAnc2V0dGluZ3MuanNvbicpLFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodXNlclNldHRpbmdzKSxcbiAgICAgICAgICAgICd1dGYtOCdcbiAgICAgICAgKVxuXG4gICAgICAgIGlmICh0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgpIHtcbiAgICAgICAgICAgIGN1c3RvbUFyZ3MuZm9sZGVyVXJpID0gYGZpbGU6JHtzbGFzaCh0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgpfWBcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl92c2NvZGVPcHRpb25zLmZpbGVQYXRoKSB7XG4gICAgICAgICAgICBjdXN0b21BcmdzLmZpbGVVcmkgPSBgZmlsZToke3NsYXNoKHRoaXMuX3ZzY29kZU9wdGlvbnMuZmlsZVBhdGgpfWBcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl92c2NvZGVPcHRpb25zLnZlcmJvc2VMb2dnaW5nKSB7XG4gICAgICAgICAgICBjdXN0b21BcmdzLnZlcmJvc2UgPSB0cnVlXG4gICAgICAgICAgICBjdXN0b21BcmdzLmxvZ0V4dGVuc2lvbkhvc3RDb21tdW5pY2F0aW9uID0gdHJ1ZVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYmluYXJ5ID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2Nocm9taXVtJywgYGluZGV4LiR7cHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICdleGUnIDogJ2pzJ31gKVxuICAgICAgICBjb25zdCBhcmdzID0gT2JqZWN0LmVudHJpZXMoeyAuLi5jdXN0b21BcmdzLCAuLi50aGlzLl92c2NvZGVPcHRpb25zLnZzY29kZUFyZ3MgfSkucmVkdWNlKFxuICAgICAgICAgICAgKHByZXYsIFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlY2FtZWxpemVkS2V5ID0gZGVjYW1lbGl6ZShrZXksIHsgc2VwYXJhdG9yOiAnLScgfSlcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwYW5kZWRBcmdzID0gdmFsdWUubWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgKHZhbCkgPT4gYC0tJHtkZWNhbWVsaXplZEtleX0ke2dldFZhbHVlU3VmZml4KHZhbCl9YFxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbLi4ucHJldiwgLi4uZXhwYW5kZWRBcmdzXVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBbLi4ucHJldiwgYC0tJHtkZWNhbWVsaXplZEtleX0ke2dldFZhbHVlU3VmZml4KHZhbHVlKX1gXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFtdIGFzIHN0cmluZ1tdXG4gICAgICAgIClcblxuICAgICAgICAvKipcbiAgICAgICAgICogbmVlZCB0byByZW5hbWUgY2FwYWJpbGl0eSBiYWNrIHRvIENocm9tZSBvdGhlcndpc2UgQ2hyb21lZHJpdmVyXG4gICAgICAgICAqIHdvbid0IHJlY29nbmlzZSB0aGlzIGNhcGFiaWxpdHlcbiAgICAgICAgICovXG4gICAgICAgIGNhcGFiaWxpdGllcy5icm93c2VyTmFtZSA9ICdjaHJvbWUnXG4gICAgICAgIGNhcGFiaWxpdGllc1snZ29vZzpjaHJvbWVPcHRpb25zJ10gPSB7IGJpbmFyeSwgYXJncywgd2luZG93VHlwZXM6IFsnd2VidmlldyddIH1cbiAgICAgICAgbG9nLmluZm8oYFN0YXJ0IFZTQ29kZTogJHtiaW5hcnl9ICR7YXJncy5qb2luKCcgJyl9YClcbiAgICB9XG5cbiAgICBiZWZvcmVDb21tYW5kIChjb21tYW5kTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmIChjb21tYW5kTmFtZSA9PT0gJ2RlbGV0ZVNlc3Npb24nKSB7XG4gICAgICAgICAgICB0aGlzLl9kZWxldGluZ1Nlc3Npb24gPSB0cnVlXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBiZWZvcmUgKGNhcGFiaWxpdGllczogVlNDb2RlQ2FwYWJpbGl0aWVzLCBfXzogbmV2ZXIsIGJyb3dzZXI6IFdlYmRyaXZlcklPLkJyb3dzZXIpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9ubHkgcnVuIHNldHVwIGZvciBWU0NvZGUgY2FwYWJpbGl0aWVzXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIWlzVlNDb2RlQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBvcGVuIFZTQ29kZSB3ZWIgd2hlbiB0ZXN0aW5nIHdlYiBleHRlbnNpb25zXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5faXNXZWJTZXNzaW9uKSB7XG4gICAgICAgICAgICBhd2FpdCBicm93c2VyLnVybCgnLycpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB2c0NvZGVWZXJzaW9uID0gY2FwYWJpbGl0aWVzW1ZTQ09ERV9DQVBBQklMSVRZX0tFWV0/LnZlcnNpb24gfHwgY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uIHx8ICdpbnNpZGVycydcbiAgICAgICAgdGhpcy5fYnJvd3NlciA9IGJyb3dzZXJcbiAgICAgICAgY29uc3QgbG9jYXRvcnMgPSBhd2FpdCBnZXRMb2NhdG9ycyh2c0NvZGVWZXJzaW9uKVxuICAgICAgICBjb25zdCB3b3JrYmVuY2hQTyA9IG5ldyBXb3JrYmVuY2gobG9jYXRvcnMpXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZ2V0V29ya2JlbmNoJywgKCkgPT4gd29ya2JlbmNoUE8ud2FpdCgpKVxuICAgICAgICB0aGlzLl9icm93c2VyLmFkZENvbW1hbmQoJ2V4ZWN1dGVXb3JrYmVuY2gnLCB0aGlzLl9leGVjdXRlVlNDb2RlLmJpbmQodGhpcykpXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZ2V0VlNDb2RlVmVyc2lvbicsICgpID0+IHZzQ29kZVZlcnNpb24pXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnaXNWU0NvZGVXZWJTZXNzaW9uJywgKCkgPT4gdGhpcy5faXNXZWJTZXNzaW9uKVxuICAgICAgICB0aGlzLl9icm93c2VyLmFkZENvbW1hbmQoJ2dldFZTQ29kZUNoYW5uZWwnLCAoKSA9PiAoXG4gICAgICAgICAgICBjYXBhYmlsaXRpZXMuYnJvd3NlclZlcnNpb24gPT09ICdpbnNpZGVycycgPyAnaW5zaWRlcnMnIDogJ3ZzY29kZSdcbiAgICAgICAgKSlcbiAgICAgICAgYXdhaXQgd29ya2JlbmNoUE8uZWxlbS53YWl0Rm9yRXhpc3QoKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBWU0NvZGUgaW4gdGhlIGJyb3dzZXIgZG9lc24ndCBhbGxvdyB0byBoYXZlIGEgZmlsZSBkaXJlY3RseSBvcGVuZWQsXG4gICAgICAgICAqIHRoZXJlZm9yZSB3ZSBuZWVkIHRvIG9wZW4gaXQgYXV0b21hdGljYWxseVxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMuX2lzV2ViU2Vzc2lvbiAmJiB0aGlzLl92c2NvZGVPcHRpb25zLmZpbGVQYXRoICYmIHRoaXMuX3ZzY29kZU9wdGlvbnMud29ya3NwYWNlUGF0aCkge1xuICAgICAgICAgICAgY29uc3Qgc2VjdGlvbnMgPSB0aGlzLl92c2NvZGVPcHRpb25zLmZpbGVQYXRoLnJlcGxhY2UodGhpcy5fdnNjb2RlT3B0aW9ucy53b3Jrc3BhY2VQYXRoLCAnJylcbiAgICAgICAgICAgICAgICAuc3BsaXQocGF0aC5zZXApLmZpbHRlcihCb29sZWFuKVxuICAgICAgICAgICAgY29uc3QgZmlsZUV4cGxvcmVyID0gYXdhaXQgYnJvd3Nlci4kKCcuZXhwbG9yZXItZm9sZGVycy12aWV3JylcbiAgICAgICAgICAgIHdoaWxlIChzZWN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSBzZWN0aW9ucy5zaGlmdCgpXG4gICAgICAgICAgICAgICAgYXdhaXQgZmlsZUV4cGxvcmVyLiQoYHNwYW49JHtlbnRyeX1gKS5jbGljaygpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBhZnRlciAoKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgICFpc1ZTQ29kZUNhcGFiaWxpdHkodGhpcy5fY2FwYWJpbGl0aWVzKVxuICAgICAgICAgICAgfHwgIXRoaXMuX2Jyb3dzZXJcbiAgICAgICAgICAgIHx8ICF0aGlzLl9jYXBhYmlsaXRpZXNbVlNDT0RFX0NBUEFCSUxJVFlfS0VZXT8udmVyYm9zZUxvZ2dpbmdcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGxvZ3MgPSBhd2FpdCB0aGlzLl9icm93c2VyLmdldExvZ3MoJ2Jyb3dzZXInKS50aGVuKFxuICAgICAgICAgICAgKHJlcykgPT4gcmVzIGFzIFdESU9Mb2dzW10sXG4gICAgICAgICAgICAoZXJyKSA9PiBlcnIgYXMgRXJyb3JcbiAgICAgICAgKVxuXG4gICAgICAgIGlmIChsb2dzIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBsIG9mIGxvZ3MpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKFxuICAgICAgICAgICAgICAgIGBbJHsobmV3IERhdGUobC50aW1lc3RhbXApKS50b0lTT1N0cmluZygpfV1gXG4gICAgICAgICAgICAgICAgKyBgIC0gJHtsLnNvdXJjZX0gLSAke2wubWVzc2FnZX1gXG4gICAgICAgICAgICApXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fd3NzKSB7XG4gICAgICAgICAgICB0aGlzLl93c3MuY2xvc2UoKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZXhlY3V0ZVZTQ29kZSAoZm46IEZ1bmN0aW9uIHwgc3RyaW5nLCAuLi5wYXJhbXM6IGFueVtdKSB7XG4gICAgICAgIGlmICghdGhpcy5fcHJvbWlzZWRTb2NrZXQgfHwgdGhpcy5faXNXZWJTZXNzaW9uKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSB0aGlzLl9pc1dlYlNlc3Npb25cbiAgICAgICAgICAgICAgICA/ICdub3Qgc3VwcG9ydCB3aGVuIHRlc3Rpbmcgd2ViIGV4dGVuc2lvbnMnXG4gICAgICAgICAgICAgICAgOiAnc2VlIFwidnNjb2RlUHJveHlPcHRpb25zXCIgb3B0aW9uIGluIHNlcnZpY2UgZG9jcydcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVlNDb2RlIEFQSSBwcm94eSBub3QgZW5hYmxlZCwgJHtlcnJvck1lc3NhZ2V9YClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNvY2tldCA9IGF3YWl0IHRoaXMuX3Byb21pc2VkU29ja2V0XG5cbiAgICAgICAgY29uc3QgcHJveHlGbiA9IHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICAgPyBmbi50b1N0cmluZygpXG4gICAgICAgICAgICA6IGZuXG5cbiAgICAgICAgc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoPFJlbW90ZUNvbW1hbmQ+e1xuICAgICAgICAgICAgaWQ6IHRoaXMuX21lc3NhZ2VJZCxcbiAgICAgICAgICAgIGZuOiBwcm94eUZuLFxuICAgICAgICAgICAgcGFyYW1zXG4gICAgICAgIH0pKVxuXG4gICAgICAgIGNvbnN0IHJldHVyblZhbCA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNtZFRpbWVvdXQgPSBzZXRUaW1lb3V0KFxuICAgICAgICAgICAgICAgICgpID0+IHJlamVjdChuZXcgRXJyb3IoJ1JlbW90ZSBjb21tYW5kIHRpbWVvdXQgZXhjZWVkZWQnKSksXG4gICAgICAgICAgICAgICAgdGhpcy5fcHJveHlPcHRpb25zLmNvbW1hbmRUaW1lb3V0XG4gICAgICAgICAgICApXG4gICAgICAgICAgICB0aGlzLl9wZW5kaW5nTWVzc2FnZXMuc2V0KHRoaXMuX21lc3NhZ2VJZCwgKGVycm9yOiBzdHJpbmcgfCB1bmRlZmluZWQsIHJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNtZFRpbWVvdXQpXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoZXJyb3IpKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgICB0aGlzLl9tZXNzYWdlSWQgKz0gMVxuICAgICAgICByZXR1cm4gcmV0dXJuVmFsXG4gICAgfVxufVxuXG5pbnRlcmZhY2UgVlNDb2RlQ29tbWFuZHMge1xuICAgIGdldFdvcmtiZW5jaDogKCkgPT4gUHJvbWlzZTxXb3JrYmVuY2g+XG4gICAgLy8gVG9kbyhDaHJpc3RpYW4pOiBwcm9wZXJseSB0eXBlIFZTQ29kZSBvYmplY3QgaGVyZVxuICAgIGV4ZWN1dGVXb3JrYmVuY2g6IDxUPihmbjogKHZzY29kZTogYW55LCAuLi5wYXJhbXM6IGFueVtdKSA9PiBULCAuLi5wYXJhbXM6IGFueVtdKSA9PiBQcm9taXNlPFQ+XG4gICAgZ2V0VlNDb2RlVmVyc2lvbjogKCkgPT4gUHJvbWlzZTxzdHJpbmc+XG4gICAgZ2V0VlNDb2RlQ2hhbm5lbDogKCkgPT4gUHJvbWlzZTxzdHJpbmc+XG4gICAgaXNWU0NvZGVXZWJTZXNzaW9uOiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+XG59XG5cbmRlY2xhcmUgZ2xvYmFsIHtcbiAgICBuYW1lc3BhY2UgV2ViZHJpdmVySU8ge1xuICAgICAgICBpbnRlcmZhY2UgQnJvd3NlciBleHRlbmRzIFZTQ29kZUNvbW1hbmRzIHt9XG4gICAgfVxuXG4gICAgbmFtZXNwYWNlIFdlYmRyaXZlcklPQXN5bmMge1xuICAgICAgICBpbnRlcmZhY2UgQnJvd3NlciBleHRlbmRzIFZTQ29kZUNvbW1hbmRzIHt9XG4gICAgICAgIGludGVyZmFjZSBNdWx0aVJlbW90ZUJyb3dzZXIgZXh0ZW5kcyBWU0NvZGVDb21tYW5kcyB7IH1cbiAgICB9XG59XG4iXX0=